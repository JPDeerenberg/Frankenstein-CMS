<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Frankenstein CMS v3.2 üß†</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css"
    />

    <link
      href="https://cdn.quilljs.com/1.3.6/quill.core.css"
      rel="stylesheet"
    />
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
      body {
        max-width: none;
        padding: 0;
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: #0d1117;
      }
      .screen {
        display: none;
        height: 100%;
        box-sizing: border-box;
      }
      .screen.active {
        display: flex;
      }

      #login-screen {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .login-box {
        background: #202b38;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 500px;
      }

      #dashboard-screen {
        flex-direction: row;
        overflow: hidden;
      }
      .sidebar {
        width: 300px;
        background: #161f27;
        padding: 20px;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #333;
        overflow-y: auto;
      }
      .main-content {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        background: #0d1117;
      }

      #editor-wrapper {
        background: white;
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-radius: 4px;
        position: relative;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      }

      #editor-host {
        flex: 1;
        display: block;
        overflow-y: auto;
        position: relative;
        background: white;
        contain: content;
      }

      #telepathic-menu {
        position: fixed;
        z-index: 99999;
        background: #222;
        padding: 8px 12px;
        border-radius: 8px;
        display: none;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        transform: translateX(-50%);
        white-space: nowrap;
        pointer-events: auto;
      }
      #telepathic-menu::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -6px;
        border-width: 6px;
        border-style: solid;
        border-color: #222 transparent transparent transparent;
      }
      #telepathic-menu button {
        background: transparent;
        border: none;
        color: white;
        font-weight: bold;
        cursor: pointer;
        padding: 5px 10px;
        margin: 0;
        font-size: 16px;
        width: auto;
        display: inline-block;
      }
      #telepathic-menu button:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #62c4ff;
        border-radius: 4px;
      }
      #telepathic-menu .divider {
        display: inline-block;
        width: 1px;
        height: 16px;
        background: #555;
        margin: 0 5px;
        vertical-align: middle;
      }

      #file-list {
        list-style: none;
        padding: 0;
        margin-top: 20px;
      }
      #file-list li {
        padding: 10px;
        border-bottom: 1px solid #333;
        cursor: pointer;
      }
      #file-list li:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      #file-list li.active {
        background: var(--background-body);
        border-left: 3px solid var(--selection);
        font-weight: bold;
      }

      .status-bar {
        margin-top: 15px;
        font-size: 0.85em;
        text-align: center;
      }
      .current-file-display {
        background: #202b38;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: monospace;
      }
      button.danger {
        background-color: #e74c3c;
        margin-top: auto;
      }
      button.action {
        width: auto;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="telepathic-menu">
      <button onmousedown="fmt('bold')" title="Bold">B</button>
      <button onmousedown="fmt('italic')" title="Italic">I</button>
      <button onmousedown="fmt('underline')" title="Underline">U</button>
      <div class="divider"></div>
      <button onmousedown="fmt('header', 2)" title="Heading 2">H2</button>
      <button onmousedown="fmt('header', 3)" title="Heading 3">H3</button>
      <div class="divider"></div>
      <button onmousedown="askLink()" title="Link">üîó</button>
      <button onmousedown="fmt('link', false)" title="Unlink">‚ùå</button>
    </div>

    <div id="login-screen" class="screen active">
      <div class="login-box">
        <h2 style="text-align: center; margin-top: 0">üßü‚Äç‚ôÇÔ∏è Frankenstein CMS</h2>
        <p style="text-align: center; opacity: 0.7; margin-bottom: 30px">
          v3.2: Quill Event Fix
        </p>
        <label>1. GitHub Token</label>
        <input
          type="password"
          id="cfg-token"
          placeholder="github_pat_xxxxxxxxxxxx"
        />
        <label>2. GitHub Username</label>
        <input type="text" id="cfg-owner" placeholder="e.g. lex-luthor" />
        <label>3. Repository Name</label>
        <input
          type="text"
          id="cfg-repo"
          placeholder="e.g. kill-superman-script"
        />
        <hr style="margin: 20px 0; border-color: #444" />
        <label style="color: #62c4ff">üîê Session Password</label>
        <input type="password" id="cfg-password" placeholder="Password" />
        <button onclick="saveConfigAndLogin()">üîì Connect</button>
        <div id="login-msg" class="status-bar"></div>
      </div>
    </div>

    <div id="dashboard-screen" class="screen">
      <div class="sidebar">
        <h3 style="margin-top: 0">üóÇ Files</h3>
        <button onclick="fetchFileList()">üîÑ Refresh</button>
        <ul id="file-list">
          <li style="font-style: italic; opacity: 0.5">Laden...</li>
        </ul>
        <div
          style="
            margin-top: 20px;
            font-size: 0.8em;
            color: #aaa;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 4px;
          "
        >
          <strong>üí° Tip:</strong><br />
          Select text in a red box. The menu appears instantly.
        </div>
        <button class="danger" onclick="logout()">üö™ Logout</button>
      </div>

      <div class="main-content">
        <div class="current-file-display">
          <span id="active-filename">...</span>
          <span id="save-status" style="color: #f1c40f"></span>
        </div>
        <div id="editor-wrapper">
          <div id="editor-host"></div>
        </div>
        <div style="display: flex; justify-content: flex-end; margin-top: 15px">
          <button
            id="saveBtn"
            class="action"
            onclick="slaOp()"
            style="display: none"
          >
            üíæ Save & Push
          </button>
        </div>
      </div>
    </div>

    <script>
      let config = { token: "", owner: "", repo: "" };
      let currentSha = "";
      let originalRawHTML = "";
      let currentPath = "";
      let shadow = null;
      let activeQuill = null;

      function encryptConfig(conf, password) {
        try {
          const ciphertext = CryptoJS.AES.encrypt(
            JSON.stringify(conf),
            password
          ).toString();
          localStorage.setItem("frankenstein_encrypted_cfg", ciphertext);
          return true;
        } catch (e) {
          return false;
        }
      }
      function decryptConfig(password) {
        try {
          const ciphertext = localStorage.getItem("frankenstein_encrypted_cfg");
          if (!ciphertext) return null;
          const bytes = CryptoJS.AES.decrypt(ciphertext, password);
          return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        } catch (e) {
          return null;
        }
      }
      window.onload = () => {
        const hasData = localStorage.getItem("frankenstein_encrypted_cfg");
        if (hasData) {
          const password = prompt("üîê Session password:");
          if (!password) return;
          const decrypted = decryptConfig(password);
          if (decrypted) {
            config = decrypted;
            showDashboard();
          } else {
            alert("‚ùå Wrong password.");
          }
        }
      };
      async function saveConfigAndLogin() {
        const token = document.getElementById("cfg-token").value.trim();
        const owner = document.getElementById("cfg-owner").value.trim();
        const repo = document.getElementById("cfg-repo").value.trim();
        const password = document.getElementById("cfg-password").value.trim();
        if (!token || !owner || !repo || !password)
          return alert("Please fill in all fields.");

        try {
          const res = await fetch(
            `https://api.github.com/repos/${owner}/${repo}`,
            { headers: { Authorization: `token ${token}` } }
          );
          if (!res.ok) throw new Error("GitHub error");
          config = { token, owner, repo };
          encryptConfig(config, password);
          showDashboard();
        } catch (e) {
          alert(e.message);
        }
      }
      function logout() {
        if (confirm("Logout?")) {
          localStorage.removeItem("frankenstein_encrypted_cfg");
          location.reload();
        }
      }

      function showDashboard() {
        document.getElementById("login-screen").classList.remove("active");
        document.getElementById("dashboard-screen").classList.add("active");
        fetchFileList();
      }

      const menu = document.getElementById("telepathic-menu");

      window.fmt = function (type, val) {
        if (!activeQuill) return;

        const range = activeQuill.getSelection();
        if (!range || range.length === 0) return;

        activeQuill.focus();

        activeQuill.setSelection(range.index, range.length);

        if (val === undefined) {
          const currentFormat = activeQuill.getFormat(
            range.index,
            range.length
          );
          activeQuill.format(type, !currentFormat[type]);
        } else {
          activeQuill.format(type, val);
        }
      };

      window.askLink = function () {
        if (!activeQuill) return;

        const range = activeQuill.getSelection();
        if (!range || range.length === 0) return;

        activeQuill.focus();

        activeQuill.setSelection(range.index, range.length);

        const url = prompt("URL:", "https://");
        if (url) {
          activeQuill.format("link", url);
        }
      };

      function resolvePath(base, rel) {
        if (rel.startsWith("/")) return rel.substring(1);
        const stack = base ? base.split("/").filter((p) => p.length) : [];
        rel.split("/").forEach((p) => {
          if (p == "..") {
            if (stack.length) stack.pop();
          } else if (p != "." && p != "") stack.push(p);
        });
        return stack.join("/");
      }

      async function loadFile(path, menuElement) {
        if (menuElement) {
          document
            .querySelectorAll("#file-list li")
            .forEach((l) => l.classList.remove("active"));
          menuElement.classList.add("active");
        }
        currentPath = path;
        document.getElementById("active-filename").innerText = path;

        const host = document.getElementById("editor-host");
        if (!host.shadowRoot) shadow = host.attachShadow({ mode: "open" });
        else shadow = host.shadowRoot;

        shadow.innerHTML = `<div style="padding:20px; color:#666;">Loading...</div>`;
        document.getElementById("saveBtn").style.display = "none";
        menu.style.display = "none";

        try {
          const res = await fetch(
            `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${path}`,
            { headers: { Authorization: `token ${config.token}` } }
          );
          const data = await res.json();
          currentSha = data.sha;
          originalRawHTML = decodeURIComponent(
            escape(window.atob(data.content))
          );

          const parser = new DOMParser();
          const doc = parser.parseFromString(originalRawHTML, "text/html");

          shadow.innerHTML = "";

          const qCss = document.createElement("link");
          qCss.rel = "stylesheet";
          qCss.href = "https://cdn.quilljs.com/1.3.6/quill.core.css";
          shadow.appendChild(qCss);

          const styleFix = document.createElement("style");
          styleFix.textContent = `
            .ql-editor { 
              padding: 0 !important; 
              overflow-y: visible; 
              font-family: inherit; 
              font-size: inherit;
              margin: 0 !important;
            }
            .ql-container { 
              font-family: inherit; 
              font-size: inherit;
              margin: 0 !important;
              padding: 0 !important;
            }
            [data-editable] { 
              border: 2px dashed #e74c3c; 
              cursor: text;
              padding: 0 !important;
              margin: 0 !important;
              box-sizing: border-box;
              display: block;
            }
            [data-editable]:hover { 
              border-style: solid; 
            }
            a { cursor: alias !important; } 
          `;
          shadow.appendChild(styleFix);

          const pageWrapper = document.createElement("div");
          pageWrapper.id = "cms-page-content";
          pageWrapper.innerHTML = doc.body.innerHTML;
          shadow.appendChild(pageWrapper);

          const links = doc.querySelectorAll('link[rel="stylesheet"]');
          const currentDir = currentPath.includes("/")
            ? currentPath.substring(0, currentPath.lastIndexOf("/"))
            : "";
          links.forEach(async (l) => {
            try {
              const href = l.getAttribute("href");
              if (!href || href.startsWith("http")) return;
              const r = await fetch(
                `https://api.github.com/repos/${config.owner}/${
                  config.repo
                }/contents/${resolvePath(currentDir, href)}`,
                { headers: { Authorization: `token ${config.token}` } }
              );
              const d = await r.json();
              const s = document.createElement("style");
              s.textContent = decodeURIComponent(
                escape(window.atob(d.content))
              );
              shadow.appendChild(s);
            } catch (e) {}
          });

          const imgs = pageWrapper.querySelectorAll("img");
          imgs.forEach(async (img) => {
            const src = img.getAttribute("src");
            if (!src || src.startsWith("http")) return;
            img.setAttribute("data-original-src", src);
            try {
              const r = await fetch(
                `https://api.github.com/repos/${config.owner}/${
                  config.repo
                }/contents/${resolvePath(currentDir, src)}`,
                {
                  headers: {
                    Authorization: `token ${config.token}`,
                    Accept: "application/vnd.github.v3.raw",
                  },
                }
              );
              if (r.ok) img.src = URL.createObjectURL(await r.blob());
            } catch (e) {}
          });

          pageWrapper
            .querySelectorAll("a")
            .forEach((a) =>
              a.addEventListener("click", (e) => e.preventDefault())
            );

          const editables = pageWrapper.querySelectorAll("[data-editable]");
          editables.forEach((el) => {
            const q = new Quill(el, {
              formats: [
                "header",
                "bold",
                "italic",
                "underline",
                "link",
                "image",
                "list",
              ],
              modules: { toolbar: false },
            });
            el.__quill = q;

            function showMenuAtRect(rect, quillInstance) {
              activeQuill = quillInstance || activeQuill;
              const top = rect.top - 50;
              const left = rect.left + rect.width / 2;
              menu.style.top = `${top}px`;
              menu.style.left = `${left}px`;
              menu.style.display = "block";
            }

            const handleSelection = () => {
              try {
                const sel = window.getSelection();
                if (
                  !sel ||
                  sel.rangeCount === 0 ||
                  sel.toString().length === 0
                ) {
                  menu.style.display = "none";
                  return;
                }

                const r = sel.getRangeAt(0);
                if (
                  el.contains(r.startContainer) ||
                  el.contains(r.commonAncestorContainer)
                ) {
                  activeQuill = q;
                  showMenuAtRect(r.getBoundingClientRect(), q);
                } else {
                  menu.style.display = "none";
                }
              } catch (e) {
                menu.style.display = "none";
              }
            };

            q.on("selection-change", function (range) {
              if (range && range.length > 0) {
                activeQuill = q;

                try {
                  const bounds = q.getBounds(range.index, range.length);
                  const containerRect = q.container.getBoundingClientRect();
                  const top = containerRect.top + bounds.top - 50;
                  const left =
                    containerRect.left + bounds.left + bounds.width / 2;
                  menu.style.top = `${top}px`;
                  menu.style.left = `${left}px`;
                  menu.style.display = "block";
                } catch (e) {
                  handleSelection();
                }
              } else {
                menu.style.display = "none";
              }
            });

            const qlEditor = el.querySelector(".ql-editor");
            if (qlEditor) {
              qlEditor.addEventListener("mouseup", handleSelection);
              qlEditor.addEventListener("keyup", handleSelection);
            }
          });

          host.addEventListener("scroll", () => (menu.style.display = "none"));

          document.getElementById("saveBtn").style.display = "inline-block";
        } catch (e) {
          shadow.innerHTML = `<p style="color:red; padding:20px;">${e.message}</p>`;
        }
      }

      async function fetchFileList() {
        const listEl = document.getElementById("file-list");
        try {
          const res = await fetch(
            `https://api.github.com/repos/${config.owner}/${config.repo}/contents/`,
            { headers: { Authorization: `token ${config.token}` } }
          );
          const data = await res.json();
          listEl.innerHTML = "";
          data
            .filter((f) => f.name.endsWith(".html"))
            .forEach((file) => {
              const li = document.createElement("li");
              li.innerText = file.name;
              li.onclick = () => loadFile(file.path, li);
              listEl.appendChild(li);
            });
        } catch (e) {
          listEl.innerHTML = "Error";
        }
      }

      async function slaOp() {
        const btn = document.getElementById("saveBtn");
        btn.innerText = "Saving...";
        btn.disabled = true;
        try {
          const wrapper = shadow.getElementById("cms-page-content");
          const clone = wrapper.cloneNode(true);

          clone.querySelectorAll(".ql-editor").forEach((ed) => {
            const cleanHTML = ed.innerHTML;
            const parent = ed.parentElement;
            parent.innerHTML = cleanHTML;
            parent.classList.remove(
              "ql-container",
              "ql-disabled",
              "ql-snow",
              "ql-core"
            );
            parent.removeAttribute("contenteditable");
            parent
              .querySelectorAll(".ql-tooltip, .ql-clipboard")
              .forEach((x) => x.remove());
            delete parent.__quill;
          });

          clone.querySelectorAll("img[data-original-src]").forEach((i) => {
            i.src = i.getAttribute("data-original-src");
            i.removeAttribute("data-original-src");
          });

          const parser = new DOMParser();
          const doc = parser.parseFromString(originalRawHTML, "text/html");
          doc.body.innerHTML = clone.innerHTML;

          const newHTML = new XMLSerializer().serializeToString(doc);
          const encoded = window.btoa(unescape(encodeURIComponent(newHTML)));

          await fetch(
            `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${currentPath}`,
            {
              method: "PUT",
              headers: {
                Authorization: `token ${config.token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                message: "Frankenstein Save",
                content: encoded,
                sha: currentSha,
              }),
            }
          );

          const r = await fetch(
            `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${currentPath}`,
            { headers: { Authorization: `token ${config.token}` } }
          );
          currentSha = (await r.json()).sha;
          originalRawHTML = newHTML;
          alert("‚úÖ Saved!");
        } catch (e) {
          alert("Error: " + e.message);
        }
        btn.innerText = "üíæ Save & Push";
        btn.disabled = false;
      }
    </script>
  </body>
</html>
